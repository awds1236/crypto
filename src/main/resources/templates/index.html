<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가상화폐 AI 분석 서비스</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .analysis-result {
            display: none;
            margin-top: 20px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        .card-header {
            background-color: #007bff;
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: bold;
            padding: 12px 15px;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            padding: 8px 20px;
            font-weight: 500;
        }
        .btn-primary:hover {
            background-color: #0069d9;
            border-color: #0062cc;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .news-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .news-item:last-child {
            border-bottom: none;
        }
        .news-title {
            font-weight: bold;
        }
        .news-date {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .indicator-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .indicator-label {
            color: #6c757d;
        }
        .fear-greed-value {
            font-size: 2rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-12">
                <h1 class="text-center">가상화폐 AI 분석 서비스</h1>
                <p class="text-center text-muted">기술적 지표와 공포/욕심 지수, 뉴스 등을 분석하여 가상화폐 예측 정보를 제공합니다.</p>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mx-auto">
                <div class="card">
                    <div class="card-header">
                        코인 선택
                    </div>
                    <div class="card-body">
                        <select id="marketSelect" class="form-select mb-3">
                            <option value="">코인을 선택하세요</option>
                        </select>
                        <button id="analyzeBtn" class="btn btn-primary w-100">분석하기</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="loading" class="loading mt-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">분석 중입니다... 잠시만 기다려주세요.</p>
        </div>
        
        <div id="analysisResult" class="analysis-result">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            AI 분석 결과
                        </div>
                        <div class="card-body">
                            <div id="analysisText" class="p-2"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card mb-3">
                        <div class="card-header">
                            기술적 지표
                        </div>
                        <div class="card-body">
                            <div id="technicalIndicators"></div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            공포/욕심 지수
                        </div>
                        <div class="card-body text-center">
                            <div id="fearGreedIndex"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            가격 차트
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="priceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            RSI 차트
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="rsiChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            관련 뉴스
                        </div>
                        <div class="card-body">
                            <div id="newsContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 코인 목록 로드
            loadMarkets();
            
            // 분석 버튼 이벤트
            document.getElementById('analyzeBtn').addEventListener('click', function() {
                const market = document.getElementById('marketSelect').value;
                if (market) {
                    analyzeMarket(market);
                } else {
                    alert('코인을 선택해주세요');
                }
            });
        });
        
        function loadMarkets() {
            fetch('/markets')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('marketSelect');
                    
                    // KRW 마켓만 필터링
                    const krwMarkets = data.filter(market => market.market.startsWith('KRW-'));
                    
                    krwMarkets.forEach(market => {
                        const option = document.createElement('option');
                        option.value = market.market;
                        option.textContent = `${market.korean_name} (${market.market})`;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('코인 목록 로드 실패:', error));
        }
        
        function analyzeMarket(market) {
            // 로딩 표시
            document.getElementById('loading').style.display = 'block';
            document.getElementById('analysisResult').style.display = 'none';
            
            fetch(`/analyze?market=${market}`)
                .then(response => response.json())
                .then(data => {
                    // 로딩 숨김
                    document.getElementById('loading').style.display = 'none';
                    
                    if (data.success) {
                        // 분석 결과 표시
                        document.getElementById('analysisResult').style.display = 'block';
                        
                        // 텍스트 분석 결과
                        document.getElementById('analysisText').innerHTML = formatAnalysisText(data.analysis);
                        
                        // 기술적 지표
                        displayTechnicalIndicators(data.indicators.latest);
                        
                        // 공포/욕심 지수
                        displayFearGreedIndex(data.fearGreedIndex);
                        
                        // 뉴스 표시
                        displayNews(data.news);
                        
                        // 차트 그리기
                        drawPriceChart(data.indicators);
                        drawRsiChart(data.indicators.rsi14);
                    } else {
                        alert('분석 중 오류가 발생했습니다: ' + data.error);
                    }
                })
                .catch(error => {
                    document.getElementById('loading').style.display = 'none';
                    console.error('분석 실패:', error);
                    alert('서버 통신 중 오류가 발생했습니다');
                });
        }
        
        function formatAnalysisText(analysis) {
            // 줄바꿈과 마크다운 형식을 HTML로 변환
            return analysis
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }
        
        function displayTechnicalIndicators(indicators) {
            const container = document.getElementById('technicalIndicators');
            container.innerHTML = '';
            
            const table = document.createElement('table');
            table.className = 'table table-sm';
            
            Object.entries(indicators).forEach(([key, value]) => {
                const row = table.insertRow();
                
                const keyCell = row.insertCell();
                keyCell.textContent = formatIndicatorName(key);
                keyCell.className = 'indicator-label';
                
                const valueCell = row.insertCell();
                valueCell.textContent = parseFloat(value).toFixed(2);
                valueCell.className = 'indicator-value';
                
                // RSI에 따른 색상 지정
                if (key === 'rsi14') {
                    if (value > 70) {
                        valueCell.className += ' text-danger'; // 과매수
                    } else if (value < 30) {
                        valueCell.className += ' text-success'; // 과매도
                    }
                }
            });
            
            container.appendChild(table);
        }
        
        function formatIndicatorName(key) {
            const names = {
                'sma20': 'SMA (20)',
                'ema20': 'EMA (20)',
                'rsi14': 'RSI (14)'
            };
            
            return names[key] || key;
        }
        
        function displayFearGreedIndex(data) {
            const container = document.getElementById('fearGreedIndex');
            container.innerHTML = '';
            
            const value = data.value;
            const classification = data.valueClassification;
            
            const valueElement = document.createElement('div');
            valueElement.className = 'fear-greed-value mb-2';
            valueElement.textContent = value;
            
            const classElement = document.createElement('div');
            classElement.className = 'mb-1';
            classElement.textContent = classification;
            
            // 지수에 따른 색상 지정
            if (value < 25) {
                valueElement.className += ' text-danger'; // 극도의 공포
            } else if (value < 40) {
                valueElement.className += ' text-warning'; // 공포
            } else if (value < 60) {
                valueElement.className += ' text-body'; // 중립
            } else if (value < 80) {
                valueElement.className += ' text-primary'; // 욕심
            } else {
                valueElement.className += ' text-success'; // 극도의 욕심
            }
            
            container.appendChild(valueElement);
            container.appendChild(classElement);
            
            // 시각적 게이지 추가
            const gauge = document.createElement('div');
            gauge.className = 'progress';
            gauge.style.height = '20px';
            
            const bar = document.createElement('div');
            bar.className = 'progress-bar';
            bar.style.width = value + '%';
            
            // 게이지 색상
            if (value < 25) {
                bar.className += ' bg-danger';
            } else if (value < 40) {
                bar.className += ' bg-warning';
            } else if (value < 60) {
                bar.className += ' bg-info';
            } else if (value < 80) {
                bar.className += ' bg-primary';
            } else {
                bar.className += ' bg-success';
            }
            
            gauge.appendChild(bar);
            container.appendChild(gauge);
        }
        
        function displayNews(newsData) {
            const container = document.getElementById('newsContainer');
            container.innerHTML = '';
            
            if (!newsData || !newsData.news || newsData.news.length === 0) {
                container.innerHTML = '<p class="text-center">관련 뉴스가 없습니다.</p>';
                return;
            }
            
            const newsList = document.createElement('div');
            newsList.className = 'list-group';
            
            newsData.news.slice(0, 5).forEach(news => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                
                const title = document.createElement('div');
                title.className = 'news-title';
                title.textContent = news.title;
                
                const date = document.createElement('div');
                date.className = 'news-date';
                const publishedAt = new Date(news.published_on * 1000);
                date.textContent = publishedAt.toLocaleString();
                
                const url = document.createElement('a');
                url.href = news.url;
                url.target = '_blank';
                url.className = 'btn btn-sm btn-outline-primary mt-2';
                url.textContent = '뉴스 보기';
                
                newsItem.appendChild(title);
                newsItem.appendChild(date);
                newsItem.appendChild(url);
                
                newsList.appendChild(newsItem);
            });
            
            container.appendChild(newsList);
        }
        
        function drawPriceChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // 기존 차트 제거
            if (window.priceChart) {
                window.priceChart.destroy();
            }
            
            // 데이터 준비
            const sma20 = data.sma20;
            const ema20 = data.ema20;
            
            // 차트 생성
            window.priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: sma20.length}, (_, i) => i + 1),
                    datasets: [
                        {
                            label: 'SMA (20)',
                            data: sma20,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: 'EMA (20)',
                            data: ema20,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '일자'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: '가격'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        },
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: '가격 및 지표 추세'
                        }
                    }
                }
            });
        }
        
        function drawRsiChart(rsiData) {
            const ctx = document.getElementById('rsiChart').getContext('2d');
            
            // 기존 차트 제거
            if (window.rsiChart) {
                window.rsiChart.destroy();
            }
            
            // 차트 생성
            window.rsiChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: rsiData.length}, (_, i) => i + 1),
                    datasets: [{
                        label: 'RSI (14)',
                        data: rsiData,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        borderWidth: 2,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 30 || context.tick.value === 70) {
                                        return 'rgba(255, 0, 0, 0.5)';
                                    }
                                    return 'rgba(0, 0, 0, 0.1)';
                                }
                            }
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: [
                                {
                                    type: 'line',
                                    mode: 'horizontal',
                                    scaleID: 'y',
                                    value: 70,
                                    borderColor: 'rgba(255, 0, 0, 0.5)',
                                    borderWidth: 1,
                                    label: {
                                        enabled: true,
                                        content: '과매수',
                                        position: 'right'
                                    }
                                },
                                {
                                    type: 'line',
                                    mode: 'horizontal',
                                    scaleID: 'y',
                                    value: 30,
                                    borderColor: 'rgba(0, 255, 0, 0.5)',
                                    borderWidth: 1,
                                    label: {
                                        enabled: true,
                                        content: '과매도',
                                        position: 'right'
                                    }
                                }
                            ]
                        }
                    }
                }
            });
        }
        
        // WebSocket 연결 (실시간 데이터용)
        function connectWebSocket(market) {
            let socket = new SockJS('/ws');
            let stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('WebSocket 연결 성공:', frame);
                
                // 실시간 시세 구독
                stompClient.subscribe('/topic/ticker', function(message) {
                    const tickerData = JSON.parse(message.body);
                    updateRealTimePrice(tickerData);
                });
                
                // 서버에 실시간 데이터 요청
                stompClient.send("/app/subscribe", {}, JSON.stringify({
                    markets: [market]
                }));
            }, function(error) {
                console.error('WebSocket 연결 실패:', error);
            });
            
            return stompClient;
        }
        
        function updateRealTimePrice(data) {
            // 실시간 가격 업데이트 로직
            const marketName = document.getElementById('marketSelect').options[document.getElementById('marketSelect').selectedIndex].text;
            
            // 페이지 타이틀 업데이트
            document.title = `${data.trade_price.toLocaleString()} | ${marketName} - 가상화폐 AI 분석`;
            
            // 가격 변동에 따른 알림 표시 (옵션)
            if (Math.abs(data.change_rate) > 0.01) { // 1% 이상 변동 시
                const direction = data.change_rate > 0 ? '상승' : '하락';
                const changePercent = (Math.abs(data.change_rate) * 100).toFixed(2);
                
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(`${marketName} ${direction} 알림`, {
                        body: `${changePercent}% ${direction}했습니다. 현재가: ${data.trade_price.toLocaleString()}`
                    });
                }
            }
        }